---
layout: post
title:  "[DB] SQL 2"
date:   2022-03-07 19:31:29 +0900
categories: DB
---

# ê¸°ë³¸ SQL ë¬¸ë²• (3) Multi-table Query

<h2 style="color:indianred">FOREIGN KEY</h2>

ë‹¤ë¥¸ í…Œì´ë¸”ì˜ `Primary Key` í•„ë“œë¥¼ ì°¸ì¡°í•˜ëŠ” í•„ë“œë¥¼ ë§í•œë‹¤. 

ì°¸ì¡°í•˜ëŠ” ë°ì´í„°ì˜ â€œì°¸ì¡° ë¬´ê²°ì„±(referential integrity)â€ì„ í™•ì¸í•˜ê¸° ìœ„í•´ ì‚¬ìš©ëœë‹¤. ë‹¤ì‹œ ë§í•´, ì°¸ì¡°í•˜ëŠ” ë°ì´í„°ê°€ ìœ íš¨í•œ ê°’ì¸ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ ì‚¬ìš©ëœë‹¤.

- **FOREIGN KEY ìƒì„±**

    1. ë‹¤ë¥¸ í…Œì´ë¸”ì„ ìƒì„±í•œë‹¤.

        ![Untitled](/public/img/DB/Lec03/Untitled.png)

    1. Students í…Œì´ë¸”ì— `cid`ë¼ëŠ” Foreign Key ë¥¼ ì¶”ê°€í•œë‹¤.
        
        ```sql
        --- Course í…Œì´ë¸”ì˜ cid ë¥¼ ì°¸ì¡°í•˜ëŠ” FOREIGN KEY í•„ë“œì¸ cid ë¥¼ Students ì— ì¶”ê°€í•©ë‹ˆë‹¤.
        
        --- Students í…Œì´ë¸” ìƒì„±ì‹œ ì¶”ê°€í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.
        CREATE TABLE Students (
            ...,
            cid int unsigned NOT NULL,
            FOREIGN KEY (cid) REFERENCES Course (cid)
        );
        
        --- Students í…Œì´ë¸” ìƒì„± ì´í›„ì— ì¶”ê°€í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.
        ALTER TABLE Students ADD COLUMN cid int unsigned NOT NULL;
        UPDATE Students SET cid = 10;             --- ì£¼ì˜ì‚¬í•­(3) ì°¸ê³ 
        ALTER TABLE Students ADD **FOREIGN KEY (cid) REFERENCES Course (cid);**
        ```
        
        ![Untitled](/public/img/DB/Lec03/Untitled%201.png)
        
        - **ì£¼ì˜ì‚¬í•­**
            - ì°¸ì¡°í•˜ê¸° ì „ì— ì°¸ì¡°ë˜ëŠ” í…Œì´ë¸”(`Course`)ì´ ë§Œë“¤ì–´ì ¸ìˆì–´ì•¼ í•œë‹¤.
            - ì°¸ì¡°í•˜ëŠ” ì»¬ëŸ¼(`Students.cid`)ê³¼ ì°¸ì¡°ë˜ëŠ” ì»¬ëŸ¼(`Course.cid`)ì˜ ë°ì´í„° íƒ€ì…ê³¼ ê¸¸ì´ê°€ ê°™ì•„ì•¼ í•œë‹¤. (ex. `signed int` â‰  `int unsigned`) [ì°¸ê³ ](https://www.lesstif.com/dbms/mysql-general-error-1215-cannot-add-foreign-key-constraint-59343215.html)
            - â€œì°¸ì¡° ë¬´ê²°ì„±â€ ì›ì¹™ì— ë”°ë¼, ì°¸ì¡°í•˜ëŠ” ì¹¼ëŸ¼ê³¼ ì°¸ì¡°ë˜ëŠ” ì¹¼ëŸ¼ì˜ ê°’ì´ í•­ìƒ ì¼ê´€ë¼ì•¼ í•œë‹¤. ì¦‰, ì°¸ì¡°ë˜ëŠ” ì¹¼ëŸ¼ì— ì—†ëŠ” ê°’ì„ ì°¸ì¡°í•˜ëŠ” ì¹¼ëŸ¼ì´ ê°€ì§ˆ ìˆ˜ ì—†ìœ¼ë©°, ì°¸ì¡°ë˜ëŠ” í…Œì´ë¸”ì—ì„œ ê°’ì„ ë³€ê²½ì‹œì¼°ë‹¤ë©´ ì°¸ì¡°í•˜ëŠ” í…Œì´ë¸”ì—ë„ ë³€ê²½ì‚¬í•­ì´ ì ìš©ë¼ì•¼ í•œë‹¤. [ì°¸ê³ ](https://live-everyday.tistory.com/188#:~:text=document%EC%9D%98%20user_id%EB%9D%BC%EB%8A%94,%EC%B0%B8%EC%A1%B0%20%EB%AC%B4%EA%B2%B0%EC%84%B1%EC%9D%B4%20%EA%B9%A8%EC%A7%84%20%EC%98%88%EC%8B%9C%EC%9D%B4%EB%8B%A4.)
        - **ì œì•½ì¡°ê±´**
            
            ```sql
            ALTER TABLE Students ADD FOREIGN KEY (cid) 
            REFERENCES Course (cid) ON DELETE CASCADE;
                                    ON UPDATE {NO ACTION|CASCADE|SET NULL|SET DEFAULT};
            ```
            
            - ON DELETE CASCADE : ì°¸ì¡°í•˜ëŠ” í‚¤ê°€ í¬í•¨ëœ í–‰ì„ ì‚­ì œí•˜ë ¤ê³  í•˜ë©´ í•´ë‹¹ Foreign Key ê°€ í¬í•¨ë˜ì–´ ìˆëŠ” ëª¨ë“  í–‰ë„ ì‚­ì œ
            - ON UPDATE CASCADE : ì°¸ì¡°í•˜ëŠ” í‚¤ ê°’ì´ í¬í•¨ëœ í–‰ì—ì„œ í‚¤ ê°’ì„ ì—…ë°ì´íŠ¸ í•˜ë©´ í•´ë‹¹ Foreign Key ë¥¼ êµ¬ì„±í•˜ëŠ” ëª¨ë“  ê°’ë„ í‚¤ì— ì§€ì •ëœ ìƒˆ ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ë„ë¡ ì§€ì •

- **FOREIGN KEY ì‚­ì œ**
    
    ```sql
    ALTER TABLE Students DROP FOREIGN KEY Students_ibfk_1;
    ALTER TABLE Students DROP cid;
    ```
    
<br><br>
<h2 style="color:indianred">í…Œì´ë¸” JOINí•˜ê¸°</h2>

ì—¬ëŸ¬ í…Œì´ë¸”ì„ ì¡°í•©í•´ í•˜ë‚˜ì˜ ê²°ê³¼ í…Œì´ë¸”ì„ ë§Œë“ ë‹¤.
í…Œì´ë¸”ë“¤ì´ ì ì–´ë„ í•˜ë‚˜ì˜ í•„ë“œcolumnë¥¼ ê³µìœ í•˜ê³  ìˆì–´ì•¼ í•œë‹¤. 
ê²°ê³¼ í…Œì´ë¸”ì€ (ì£¼ì–´ì§„ ì¡°ê±´ì— ë§ëŠ”) ë‘ í…Œì´ë¸”ì˜ íŠœí”Œë“¤ì˜ ê°€ëŠ¥í•œ ëª¨ë“  ì¡°í•©ì„ í¬í•¨í•œë‹¤.
ì¦‰, JOINì˜ ì˜ë¯¸ëŠ”

1. ë‘ í…Œì´ë¸”ì˜ cross product ë¥¼ êµ¬í•´ 
     *ex. {a,b} x {1,2} = {a,1} {a,2} {b,1} {b,2}*
2. Selection/ì¡°ê±´ì„ ì ìš©í•´ í•„í„°ë§í•˜ê³ 
3. Pojectionì„ ì ìš©í•´ ê²°ê³¼ í…Œì´ë¸”ì„ ì–»ëŠ”ë‹¤ëŠ” ì˜ë¯¸ì´ë‹¤. 

![Untitled](/public/img/DB/Lec03/Untitled%203.png)

- ë‹¤ìŒ ë‘ í…Œì´ë¸”ì„ ê°€ì •í•œë‹¤.
    
    <details>
    <summary>í…Œì´ë¸” ìƒì„± ì¿¼ë¦¬</summary>
    <div markdown="1">    
    ```sql
    CREATE TABLE Course (
      cid int unsigned NOT NULL PRIMARY KEY,
      name varchar(20)
    );
    
    INSERT INTO Course VALUES
    (10, 'Database'),
    (11, 'OS'),
    (12, 'Network'),
    (90, 'Algorithm');

    CREATE TABLE Students ( 
    		sid int NOT NULL AUTO_INCREMENT,
    		name char(10) NOT NULL DEFAULT '',
    		department varchar(20),
    		cid int unsigned NOT NULL,
    		PRIMARY KEY (sid),
    		FOREIGN KEY (cid) REFERENCES Course(cid)
    );
    
    INSERT INTO Students VALUES
    (100, 'Fred', 'Computer Science', 10),
    (NULL, 'David', 'Electronics', 11),
    (NULL, 'John', 'Electronics', 12),
    (NULL, 'Jake', 'Computer Science', 10),
    (NULL, 'George', 'Computer Science', 11);
    ```
    </div>
    </details>

    ![Untitled](/public/img/DB/Lec03/Untitled%202.png)
    ![Untitled](/public/img/DB/Lec03/Untitled.png)


<!-- ![Untitled](/public/img/DB/Lec03/Untitled%204.png){:width="600"}
(â†’ ì´ íŠ¹ì„± ë•Œë¬¸ì— ìƒê¸°ëŠ” ì˜ˆì™¸ìƒí™©ë„ ìˆë‹¤.) -->

- **(INNER) JOIN**
    
    ì¼ë°˜ì ì¸ ì¡°ì¸. ì§€ì •í•œ í•„ë“œ(ì¡°ì¸ ì»¬ëŸ¼)ì˜ ê°’ì´ ë‘ í…Œì´ë¸” ëª¨ë‘ì— ìˆëŠ” ê²½ìš°ì—ë§Œ ì¡°íšŒëœë‹¤.
    
    ```sql
    SELECT * 
    FROM Students 
    INNER JOIN Course                              --- INNER ìƒëµ ê°€ëŠ¥í•©ë‹ˆë‹¤.
    ON Students.cid = Course.cid;
    --- cid ê°’ì´ ë™ì¼í•œ íŠœí”Œë¼ë¦¬ ì „ë¶€ ì¡°í•©í•´ì„œ 
    --- Students í…Œì´ë¸”ê³¼ Course í…Œì´ë¸”ì„ ê²°í•©í•´ì¤ë‹ˆë‹¤.
    
    SELECT *
    FROM Students, Course
    WHERE Students.cid = Course.cid;
    --- ê²°ê³¼ëŠ” ìœ„ì™€ ë™ì¼í•©ë‹ˆë‹¤.
    --- í‘œì¤€ SQL ë°©ì‹ê³¼ëŠ” ë³„ë„ë¡œ MySQLì—ì„œë§Œ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.
    ```
    
    ì¦‰, ë‹¤ìŒ ê²½ìš°ì— Course í…Œì´ë¸”ì˜ cidê°€ 90ì¸ íŠœí”Œì€ Studentsì— cidê°€ 90ì¸ íŠœí”Œì´ ì—†ìœ¼ë¯€ë¡œ ê²°ê³¼ í…Œì´ë¸”ì— ë‚˜íƒ€ë‚˜ì§€ ì•ŠëŠ”ë‹¤. 
        

    ![Untitled](/public/img/DB/Lec03/Untitled%205.png){:width="600"}
    <span>=></span>
    ![Untitled](/public/img/DB/Lec03/Untitled%206.png)

- **OUTER JOIN**
    
    ê¸°ì¤€ í…Œì´ë¸”ì—ë§Œ ë°ì´í„°ê°€ ì¡´ì¬í•˜ë©´ ì¡°íšŒëœë‹¤. ì¦‰, ì¡°ì¸ í…Œì´ë¸”ì— ë°ì´í„°ê°€ ìˆë“  ì—†ë“  ê¸°ì¤€ í…Œì´ë¸”ì˜ ë°ì´í„°ëŠ” ëª¨ë‘ ì¡°íšŒëœë‹¤. ê·¸ë¦¬ê³  ì¡°ì¸ í…Œì´ë¸”ì— ë°ì´í„°ê°€ ì—†ë‹¤ë©´ `NULL`ê°’ì´ ì±„ì›Œì§„ë‹¤.    
    ê¸°ì¤€ í…Œì´ë¸”ì„ ë¬´ì—‡ìœ¼ë¡œ ì •í• ì§€ì— ë”°ë¼ `LEFT` `RIGHT` `FULL` ì´ ì •í•´ì§„ë‹¤.
    ì°¸ê³ ë¡œ, ì˜¤ë¼í´ì—ëŠ” `(FULL) OUTER JOIN`ì´ ìˆì§€ë§Œ MySQLì—ëŠ” ì—†ê¸° ë•Œë¬¸ì— `LEFT JOIN`+`RIGHT JOIN` ë¡œ ëŒ€ì²´í•œë‹¤.
    
    ```sql
    SELECT * 
    FROM Students
    RIGHT OUTER JOIN Course             --- OUTER ìƒëµ ê°€ëŠ¥í•©ë‹ˆë‹¤.
    ON Students.cid = Course.cid;
    ```

    ![Untitled](/public/img/DB/Lec03/Untitled%207.png){:width="400"}

- **CROSS JOIN**
    
    ì¹´í‹°ì…˜ ê³±(Cartesian product) (ë˜ëŠ” ì¤‘ì²© forë¬¸)ì˜ ê°œë…ì´ë‹¤. íŠ¹ì • ê¸°ì¤€ ì—†ì´ ë‘ í…Œì´ë¸” ê°„ì— ê°€ëŠ¥í•œ ëª¨ë“  íŠœí”Œ ì¡°í•©ì˜ ê²½ìš°ì˜ ìˆ˜ë¥¼ ë³´ì—¬ì¤€ë‹¤.  `ON` ì ˆì´ ë”°ë¡œ í•„ìš” ì—†ë‹¤. ê²°ê³¼ì˜ ê°œìˆ˜ëŠ” n(A) * n(B) ì´ë‹¤.
    
    ```sql
    SELECT * 
    FROM Students
    CROSS join Course
    
    --- ê²°ê³¼ëŠ” ìœ„ì™€ ë™ì¼í•©ë‹ˆë‹¤.
    SELECT * FROM Students, Course
    ```
    
    ![Untitled](/public/img/DB/Lec03/Untitled%208.png)
    
- **SELF JOIN**
    
    ìê¸° ìì‹ ì˜ í…Œì´ë¸”ê³¼ (INNER) JOIN í•œë‹¤.
    ê° í…Œì´ë¸”ì„ êµ¬ë³„í•˜ê¸° ìœ„í•´ ë³„ì¹­(Alias)ë¥¼ ë§Œë“¤ì–´ì¤˜ì•¼ í•œë‹¤. 
    
    ```sql
    SELECT *
    FROM Course C1
    INNER JOIN Course C2       --- AS ìƒëµí•œ í˜•íƒœì…ë‹ˆë‹¤.
    ```

<h2 style="color:indianred">Nested Query</h2>

ë³µì¡í•œ ì¿¼ë¦¬ë¥¼ ì‰½ê²Œ í‘œí˜„í•˜ê¸° ìœ„í•´ì„œ ë§Œë“¤ì–´ì¡Œë‹¤.
SQL ë¬¸ ì•ˆì— ë˜ ë‹¤ë¥¸ SQL ë¬¸ì„ í¬í•¨í•˜ê³  ìˆëŠ” êµ¬ì¡°ì´ë‹¤. 
ë‚´ë¶€ ì¿¼ë¦¬ê°€ ë¨¼ì € (ë‹¨ í•œë²ˆ) ì‹¤í–‰ë˜ê³ , ê·¸ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì™¸ë¶€ ì¿¼ë¦¬ê°€ ì‹¤í–‰ëœë‹¤. 

```sql
SELECT *
FROM í•œì–‘ëŒ€í•™ìƒ AS S
WHERE S.ì´ë¦„ IN (
		SELECT K.ì´ë¦„
		FROM ëŒ€í•œë¯¼êµ­êµ­ë¯¼ AS K
		WHERE K.ë‚˜ì´ = 20);
```


- **EXISTS / NOT EXISTS**
    
    EXIST ì•ˆì˜ ì¡°ê±´ì— ë¶€í•©í•˜ëŠ” íŠœí”Œì´ â€œì¡´ì¬â€í•´ì•¼ë§Œ ì „ì²´ ê²°ê³¼ë¥¼ ì¶œë ¥í•œë‹¤.
    
    ```sql
    SELECT *
    FROM Students
    WHERE EXISTS (
    		SELECT * FROM Course
    		WHERE Course.cid = 10 AND Students.cid = Course.cid);
    ```
    
- **ALL / ANY**
    
    ```sql
    SELECT name
    FROM Product
    WHERE price > ALL (
    		SELECT price
    		FROM Product
    		WHERE maker = â€˜Gizmo-Worksâ€™)
    ```
    
<h2 style="color:indianred">View</h2>

ìì£¼ ì“°ì´ëŠ” ì¿¼ë¦¬ ê²°ê³¼ë¥¼ ì„ì‹œ ì €ì¥í•  ìˆ˜ ìˆê²Œ í•œë‹¤. 
í…Œì´ë¸”ì˜ í˜•íƒœì´ì§€ë§Œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ì§€ ì•ŠëŠ”ë‹¤. 

```sql
CREATE VIEW Class_Info AS
SELECT Students.sid, Course.cid
FROM Students, Course
WHERE Students.cid = Course.cid;
//
SELECT Class_Info.sid, Course.cid 
FROM Course,
( SELECT Students.sid, Course.cid
	FROM Students, Course
	WHERE Students.cid = Course.cid) AS Class_Info
WHERE Course.cid = Class_Info.cid;
--- ì´ ViewëŠ” í•´ë‹¹ ì¿¼ë¦¬ ì•ˆì—ì„œë§Œ ìœ íš¨í•©ë‹ˆë‹¤.
//
WITH Class_Info(sid, icid) AS
( SELECT Students.sid, Course.cid
	FROM Students, Course
	WHERE Students.cid = Course.cid),
--- VIEWì™€ ë¹„ìŠ·í•˜ì§€ë§Œ ì—¬ëŸ¬ ê°œì˜ í…Œì´ë¸”ì„ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```

![Untitled](/public/img/DB/Lec03/Untitled%209.png)

- **ì£¼ì˜ì‚¬í•­**
    - ê°™ì€ ì´ë¦„ì˜ í•„ë“œê°€ ì¡´ì¬í•  ìˆ˜ ì—†ë‹¤. 
    ex. ìœ„ êµ¬ë¬¸ì—ì„œ `SELECT *` ë¥¼ í•˜ê²Œ ë˜ë©´ ë§Œë“¤ì–´ì§€ëŠ” viewì— cid í•„ë“œê°€ ë‘ ê°œ ì¡´ì¬í•˜ë©°(`Students.cid`, `Course.cid`) ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤.



> ğŸ“Œ ì§ˆë¬¸ <br>
> *Q. inner joinê³¼ outer join ì°¨ì´*<br>
> *Q. havingê³¼ where ì°¨ì´*<br>
> *Q. group byì˜ ì—­í• *<br>
> *Q. JOIN vs. Sub-query?*<br>